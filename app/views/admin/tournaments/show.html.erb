<% content_for :title, "#{@tournament.name} — Admin" %>

<div class="d-flex align-items-center gap-3 mb-2">
  <h1 class="mb-0"><%= @tournament.name %></h1>
  <span class="badge bg-<%= @tournament.status == 'in_progress' ? 'success' : @tournament.status == 'completed' ? 'secondary' : 'primary' %>">
    <%= @tournament.status.humanize %>
  </span>
</div>
<p class="text-muted mb-4">
  Week <%= @tournament.week_number %> &middot;
  <%= @tournament.start_date&.strftime("%b %d") %> – <%= @tournament.end_date&.strftime("%b %d") %>
</p>

<% if @tournament.status == "completed" && @picks.any? && @picks.all? { |p| p.earnings_cents.nil? } %>
  <div class="alert alert-warning d-flex align-items-center gap-3">
    <span>&#9888;&#xFE0F; Tournament completed but no earnings have been entered yet.</span>
    <%= link_to "Enter Earnings →", earnings_admin_tournament_path(@tournament), class: "btn btn-warning btn-sm ms-auto" %>
  </div>
<% end %>

<div class="d-flex gap-2 mb-4 flex-wrap">
  <%= button_to "Sync Field", sync_field_admin_tournament_path(@tournament), method: :post, class: "btn btn-outline-secondary" %>
  <%= button_to "Sync Results", sync_results_admin_tournament_path(@tournament), method: :post, class: "btn btn-outline-secondary" %>
  <% if @tournament.status == "in_progress" %>
    <%= button_to "Sync Live Scores", sync_live_admin_tournament_path(@tournament), method: :post, class: "btn btn-outline-success" %>
  <% end %>
  <% if @tournament.pgatour_id.present? %>
    <%= button_to "Sync Earnings (PGA Tour)", sync_earnings_admin_tournament_path(@tournament), method: :post, class: "btn btn-primary" %>
  <% end %>
  <%= link_to "Enter Earnings Manually", earnings_admin_tournament_path(@tournament), class: "btn btn-outline-primary" %>
</div>

<div class="row">
  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header">Edit</div>
      <div class="card-body">
        <%= form_with model: [:admin, @tournament] do |f| %>
          <div class="mb-3">
            <%= f.label :status, class: "form-label" %>
            <%= f.select :status, Tournament::STATUSES.map { |s| [s.humanize, s] }, {}, class: "form-select" %>
          </div>
          <div class="mb-3">
            <%= f.label :tournament_type, class: "form-label" %>
            <%= f.select :tournament_type, Tournament::TYPES.map { |t| [t.humanize, t] }, {}, class: "form-select" %>
          </div>
          <div class="mb-3">
            <%= f.label :picks_locked_at, class: "form-label" %>
            <%= f.datetime_local_field :picks_locked_at, class: "form-control",
                value: @tournament.picks_locked_at&.in_time_zone("Eastern Time (US & Canada)")&.strftime("%Y-%m-%dT%H:%M") %>
          </div>
          <div class="mb-3">
            <%= f.label :pgatour_id, "PGA Tour ID (e.g. R2026011)", class: "form-label" %>
            <%= f.text_field :pgatour_id, class: "form-control", placeholder: "R2026011" %>
          </div>
          <%= f.submit "Save Changes", class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-8">
    <div class="card">
      <div class="card-header">Picks (<%= @picks.count %>)</div>
      <div class="card-body p-0">
        <% if @picks.any? %>
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr><th>Player</th><th>Golfer</th><th>2x</th><th>Auto?</th><th>Cut</th><th>Earnings</th></tr>
              </thead>
              <tbody>
                <% @picks.each do |pick| %>
                  <tr>
                    <td><%= pick.user.name %></td>
                    <td><%= pick.golfer.name %></td>
                    <td><%= pick.is_double_down? ? "✓" : "" %></td>
                    <td><%= pick.auto_assigned? ? "✓" : "" %></td>
                    <td><%= pick.made_cut.nil? ? "—" : (pick.made_cut? ? "✅" : "❌") %></td>
                    <td><%= pick.earnings_cents.nil? ? "—" : "$#{number_with_delimiter((pick.earnings_cents / 100.0).to_i)}" %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="p-3 text-muted mb-0">No picks yet.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%= link_to "← Back to Schedule", admin_tournaments_path, class: "btn btn-outline-secondary" %>
