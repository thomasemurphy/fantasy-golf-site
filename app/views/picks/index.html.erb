<% content_for :title, "My Picks — The Feeley Tour Cup" %>

<% if @current_tournament %>
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title"><%= @current_tournament.name %></h5>
      <p class="text-muted mb-3">
        Week <%= @current_tournament.week_number %> &middot;
        <%= @current_tournament.start_date&.strftime("%b %d") %> &ndash; <%= @current_tournament.end_date&.strftime("%b %d") %>
        <% if @current_tournament.purse_cents > 0 %>
          &middot; Purse: $<%= number_with_delimiter(@current_tournament.purse_dollars.to_i) %>
        <% end %>
      </p>

      <% if @current_pick %>
        <div class="border rounded p-3 mb-3 bg-body-secondary">
          <p class="mb-2">
            Your pick: <strong><%= @current_pick.golfer.name %></strong>
            <% if @current_pick.is_double_down? %>
              <span class="badge bg-warning text-dark ms-1">2x Double Down</span>
            <% end %>
            <% if @current_pick.auto_assigned? %>
              <span class="badge bg-secondary ms-1">Auto-assigned</span>
            <% end %>
          </p>
          <% unless @current_tournament.picks_locked? || @current_pick.auto_assigned? %>
            <%= button_to "Change Pick", pick_path(@current_pick), method: :delete,
                class: "btn btn-outline-secondary btn-sm" %>
          <% end %>
        </div>
      <% elsif @current_tournament.picks_locked? %>
        <div class="alert alert-warning">Picks are locked for this tournament.</div>
      <% else %>
        <% if @available_golfers.any? %>
          <%= form_with model: Pick.new, url: picks_path do |f| %>
            <div class="row g-3 align-items-end mb-3">
              <div class="col-sm-6">
                <%= f.label :golfer_id, "Select Golfer", class: "form-label" %>
                <%= f.select :golfer_id,
                    options_for_select(@available_golfers.map { |g| [g.name, g.id] }),
                    { prompt: "— Choose a golfer —" },
                    { class: "form-select" } %>
              </div>
              <div class="col-sm-auto">
                <div class="form-check mb-2">
                  <%= f.check_box :is_double_down, class: "form-check-input",
                      disabled: current_user.double_downs_remaining <= 0,
                      id: "is_double_down" %>
                  <%= f.label :is_double_down, class: "form-check-label" do %>
                    Double Down
                    <span class="badge bg-secondary"><%= current_user.double_downs_remaining %> remaining</span>
                  <% end %>
                </div>
              </div>
              <div class="col-sm-auto">
                <%= f.submit "Submit Pick", class: "btn btn-primary" %>
              </div>
            </div>
          <% end %>

          <% if @current_tournament.picks_locked_at %>
            <p class="deadline-note">
              Pick deadline: <strong><%= @current_tournament.picks_locked_at.in_time_zone("Eastern Time (US & Canada)").strftime("%A, %b %d at %-I:%M %p ET") %></strong>
              &mdash; <span data-controller="countdown" data-countdown-deadline-value="<%= @current_tournament.picks_locked_at.iso8601 %>">
                <span data-countdown-target="timer"></span>
              </span>
            </p>
          <% end %>
        <% else %>
          <div class="alert alert-info">No available golfers — the field may not be synced yet, or you've used everyone.</div>
        <% end %>
      <% end %>
    </div>
  </div>
<% else %>
  <div class="alert alert-info">No active tournament right now. Check back soon!</div>
<% end %>

<%# Season results %>
<div class="d-flex align-items-baseline gap-4 mb-3">
  <h2 class="mb-0">Season Results</h2>
  <span class="text-muted small"><%= current_user.double_downs_remaining %> / 5 double-downs remaining</span>
</div>

<% if @past_picks.any? %>
  <div class="standings-table-wrapper">
    <table class="standings-table">
      <thead>
        <tr>
          <th>Wk</th>
          <th>Tournament</th>
          <th>Golfer</th>
          <th>Result</th>
          <th>Earnings</th>
        </tr>
      </thead>
      <tbody>
        <% @past_picks.each do |pick| %>
          <tr>
            <td><span class="standings-rank"><%= pick.tournament.week_number %></span></td>
            <td><%= link_to pick.tournament.name, standings_path(tournament_id: pick.tournament.id) %></td>
            <td>
              <%= pick.golfer.name %>
              <% if pick.is_double_down? %>
                <span class="badge bg-warning text-dark ms-1">2x</span>
              <% end %>
              <% if pick.auto_assigned? %>
                <span class="badge bg-secondary ms-1">Auto</span>
              <% end %>
            </td>
            <td>
              <% if pick.made_cut.nil? %>
                <span class="text-muted">—</span>
              <% elsif pick.made_cut? %>
                <span class="text-success fw-semibold">Made cut</span>
              <% else %>
                <span class="text-danger fw-semibold">Missed cut</span>
              <% end %>
            </td>
            <td>
              <% if pick.earnings_cents.nil? %>
                <span class="text-muted">—</span>
              <% elsif pick.earnings_cents > 0 %>
                <span class="text-success fw-semibold">$<%= number_with_delimiter((pick.earnings_cents / 100.0).to_i) %></span>
              <% else %>
                <span class="text-muted">$0</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr class="picks-total-row">
          <td colspan="4" class="text-end fw-semibold">Season Total</td>
          <td class="fw-bold">$<%= number_with_delimiter((current_user.total_earnings_cents / 100.0).to_i) %></td>
        </tr>
      </tfoot>
    </table>
  </div>
<% else %>
  <p class="text-muted">No completed tournaments yet.</p>
<% end %>
