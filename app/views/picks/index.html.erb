<% content_for :title, "My Picks — The Feeley Tour Cup" %>

<h1 class="mb-4">My Picks</h1>

<% if @current_tournament %>
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title"><%= @current_tournament.name %></h5>
      <p class="text-muted mb-3">
        Week <%= @current_tournament.week_number %> &middot;
        <%= @current_tournament.start_date&.strftime("%b %d") %> &ndash; <%= @current_tournament.end_date&.strftime("%b %d") %>
        <% if @current_tournament.purse_cents > 0 %>
          &middot; Purse: $<%= number_with_delimiter(@current_tournament.purse_dollars.to_i) %>
        <% end %>
      </p>

      <% if @current_pick %>
        <div class="current-pick mb-3">
          <p class="mb-2">
            Your pick: <strong><%= @current_pick.golfer.name %></strong>
            <% if @current_pick.is_double_down? %>
              <span class="badge bg-warning text-dark ms-1">2x Double Down</span>
            <% end %>
            <% if @current_pick.auto_assigned? %>
              <span class="badge bg-secondary ms-1">Auto-assigned</span>
            <% end %>
          </p>
          <% unless @current_tournament.picks_locked? || @current_pick.auto_assigned? %>
            <%= button_to "Remove Pick", pick_path(@current_pick), method: :delete,
                data: { turbo_confirm: "Remove your pick for #{@current_tournament.name}?" },
                class: "btn btn-outline-danger btn-sm" %>
          <% end %>
        </div>
      <% elsif @current_tournament.picks_locked? %>
        <div class="alert alert-warning">Picks are locked for this tournament.</div>
      <% else %>
        <% if @available_golfers.any? %>
          <%= form_with model: Pick.new, url: picks_path do |f| %>
            <div class="row g-3 align-items-end mb-3">
              <div class="col-sm-6">
                <%= f.label :golfer_id, "Select Golfer", class: "form-label" %>
                <%= f.select :golfer_id,
                    options_for_select(@available_golfers.map { |g| [g.name, g.id] }),
                    { prompt: "— Choose a golfer —" },
                    { class: "form-select" } %>
              </div>
              <div class="col-sm-auto">
                <div class="form-check mb-2">
                  <%= f.check_box :is_double_down, class: "form-check-input",
                      disabled: current_user.double_downs_remaining <= 0,
                      id: "is_double_down" %>
                  <%= f.label :is_double_down, class: "form-check-label" do %>
                    Double Down
                    <span class="badge bg-secondary"><%= current_user.double_downs_remaining %> remaining</span>
                  <% end %>
                </div>
              </div>
              <div class="col-sm-auto">
                <%= f.submit "Submit Pick", class: "btn btn-primary" %>
              </div>
            </div>
          <% end %>

          <% if @current_tournament.picks_locked_at %>
            <p class="deadline-note">
              Pick deadline: <strong><%= @current_tournament.picks_locked_at.in_time_zone("Eastern Time (US & Canada)").strftime("%A, %b %d at %-I:%M %p ET") %></strong>
              &mdash; <span data-controller="countdown" data-countdown-deadline-value="<%= @current_tournament.picks_locked_at.iso8601 %>">
                <span data-countdown-target="timer"></span>
              </span>
            </p>
          <% end %>
        <% else %>
          <div class="alert alert-info">No available golfers — the field may not be synced yet, or you've used everyone.</div>
        <% end %>
      <% end %>
    </div>
  </div>
<% else %>
  <div class="alert alert-info">No active tournament right now. Check back soon!</div>
<% end %>

<div class="card">
  <div class="card-body">
    <h5 class="card-title mb-1">Season History</h5>
    <p class="text-muted mb-3">
      Double-downs remaining: <strong><%= current_user.double_downs_remaining %></strong> / 5
      &nbsp;&middot;&nbsp;
      Total earned: <strong>$<%= number_with_delimiter((current_user.total_earnings_cents / 100.0).to_i) %></strong>
    </p>

    <% if @picks.any? %>
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Wk</th>
              <th>Tournament</th>
              <th>Golfer</th>
              <th>2x</th>
              <th>Made Cut?</th>
              <th>Earned</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @picks.order("tournaments.start_date desc").each do |pick| %>
              <tr>
                <td><%= pick.tournament.week_number %></td>
                <td><%= pick.tournament.name %></td>
                <td><%= pick.golfer.name %></td>
                <td><%= pick.is_double_down? ? "✓" : "" %></td>
                <td>
                  <% if pick.made_cut.nil? %>—
                  <% elsif pick.made_cut? %><span class="text-success">✓</span>
                  <% else %><span class="text-danger">✗</span>
                  <% end %>
                </td>
                <td>
                  <% if pick.earnings_cents.nil? %>—
                  <% else %>$<%= number_with_delimiter((pick.earnings_cents / 100.0).to_i) %>
                  <% end %>
                </td>
                <td><%= pick.auto_assigned? ? '<span class="badge bg-secondary">Auto</span>'.html_safe : "" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-muted">No picks yet this season.</p>
    <% end %>
  </div>
</div>
